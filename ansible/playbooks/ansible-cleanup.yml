---
- name: Complete Ansible Cleanup (Like Terraform Destroy)
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
    - name: ğŸ§¹ Starting COMPLETE Ansible cleanup
      debug:
        msg:
          - "ğŸ—‘ï¸ COMPLETE CLEANUP - Like 'terraform destroy --auto-approve'"
          - "ğŸ“‹ Removing ALL Ansible demo resources"
          - "ğŸ’° Ensuring ZERO AWS costs remain"
          - "ğŸ” Checking: S3 buckets, policies, website configs"

    - name: ğŸ“‹ List all demo buckets
      command: /mnt/c/Windows/System32/cmd.exe /c "aws s3api list-buckets --query \"Buckets[?starts_with(Name, 'ansible-demo-')].Name\" --output text"
      register: demo_buckets
      ignore_errors: yes

    - name: ğŸ“Š Show buckets to be deleted
      debug:
        msg: "Found buckets: {{ demo_buckets.stdout.split() }}"
      when: demo_buckets.stdout != ""

    - name: ğŸ—‘ï¸ Force empty buckets (remove ALL files and versions)
      command: aws s3 rm s3://{{ item }} --recursive --force
      loop: "{{ demo_buckets.stdout.split() }}"
      when: demo_buckets.stdout != ""
      ignore_errors: yes

    - name: ğŸ”“ Remove bucket policies
      command: aws s3api delete-bucket-policy --bucket {{ item }}
      loop: "{{ demo_buckets.stdout.split() }}"
      when: demo_buckets.stdout != ""
      ignore_errors: yes

    - name: ğŸŒ Remove website configurations
      command: aws s3api delete-bucket-website --bucket {{ item }}
      loop: "{{ demo_buckets.stdout.split() }}"
      when: demo_buckets.stdout != ""
      ignore_errors: yes

    - name: ğŸ”’ Remove public access block configurations
      command: aws s3api delete-public-access-block --bucket {{ item }}
      loop: "{{ demo_buckets.stdout.split() }}"
      when: demo_buckets.stdout != ""
      ignore_errors: yes

    - name: ğŸ—‘ï¸ Force delete buckets
      command: aws s3 rb s3://{{ item }} --force
      loop: "{{ demo_buckets.stdout.split() }}"
      when: demo_buckets.stdout != ""
      ignore_errors: yes

    - name: ğŸ§¹ Clean up any orphaned multipart uploads
      command: aws s3api abort-multipart-upload --bucket {{ item }} --key dummy --upload-id dummy
      loop: "{{ demo_buckets.stdout.split() }}"
      when: demo_buckets.stdout != ""
      ignore_errors: yes

    - name: ğŸ“‹ Verify complete cleanup
      command: aws s3api list-buckets --query "Buckets[?starts_with(Name, 'ansible-demo-')].Name" --output text
      register: remaining_buckets
      ignore_errors: yes

    - name: âœ… COMPLETE CLEANUP SUCCESS
      debug:
        msg:
          - "ğŸ‰ COMPLETE CLEANUP SUCCESSFUL!"
          - "ğŸ—‘ï¸ All S3 buckets deleted"
          - "ğŸ”“ All policies removed"
          - "ğŸŒ All website configs removed"
          - "ğŸ”’ All access blocks removed"
          - "ğŸ’° ZERO AWS costs remaining"
          - "âœ… Like 'terraform destroy --auto-approve' - everything gone!"
      when: remaining_buckets.stdout == ""

    - name: âš ï¸ Cleanup verification
      debug:
        msg:
          - "âš ï¸ Some resources may still exist: {{ remaining_buckets.stdout }}"
          - "ğŸ’¡ Run cleanup again or check AWS console"
      when: remaining_buckets.stdout != ""
